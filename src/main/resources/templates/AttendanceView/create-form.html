<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absen Masuk - Sistem Monitoring</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    :root{
      --navy:#0b2340;
      --cream:#f2ece3;
      --accent:#b78b4a;
      --muted:#6c757d;
      --border:#e5e7eb;
    }

    body{
      background:var(--cream);
      color:var(--navy);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }

    .container-main{
      max-width:800px;
      margin:1.5rem auto;
      background:#fff;
      border-radius:14px;
      padding:1.75rem;
      box-shadow:0 8px 24px rgba(11,35,64,.08);
    }

    .page-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:1.25rem;
      padding-bottom:.75rem;
      border-bottom:1px solid var(--border);
    }

    .header-icon{
      width:28px;
      height:28px;
      stroke:var(--accent);
    }

    .page-title{
      margin:0;
      font-weight:700;
      font-size:1.25rem;
    }

    .form-label{
      font-weight:600;
      font-size:.78rem;
      letter-spacing:.04em;
      text-transform:uppercase;
      margin-bottom:.35rem;
    }

    .input-group-text{
      background:#fff;
      border-right:none;
      color:var(--accent);
    }

    .form-control{
      border-left:none;
      font-size:.9rem;
    }

    .readonly-field{
      background:#f9fafb!important;
    }

    /* CAMERA */
    .camera-box{
      border:1.5px dashed var(--border);
      border-radius:12px;
      padding:8px;
      background:#fafafa;
      transition:.2s;
    }

    .camera-box.active{
      border-color:var(--accent);
      background:#fff;
    }

    .camera-video{
      width:100%;
      height:240px;
      background:#000;
      border-radius:10px;
      object-fit:cover;
    }

    /* Mobile lebih besar */
    @media (max-width: 768px){
      .camera-video{
        height:320px;
      }
    }

    .camera-actions{
      display:flex;
      gap:8px;
      margin-top:6px;
    }

    .btn-outline-accent{
      border:1px solid var(--accent);
      color:var(--accent);
      background:#fff;
    }

    .btn-outline-accent:hover{
      background:var(--accent);
      color:#fff;
    }

    .btn-save{
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:10px;
      padding:.55rem 1.5rem;
      font-weight:600;
      font-size:.9rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .btn-save:disabled{
      background:#d6c4a3;
      cursor:not-allowed;
    }

    .btn-cancel{
      background:#eef0f2;
      color:var(--muted);
      border-radius:10px;
      padding:.55rem 1.3rem;
      font-weight:600;
      font-size:.9rem;
    }
  </style>
</head>

<body>
<div th:replace="~{layouts/fragments/navbar :: topbar}"></div>
<div th:replace="~{layouts/fragments/sidebar :: sidebar}"></div>

<main class="container-main">

  <div class="page-header">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
         stroke-width="1.5" stroke="currentColor" class="header-icon">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M3 7.5h18M3 12h18M3 16.5h18"/>
    </svg>
    <h3 class="page-title">Absen Masuk Harian</h3>
  </div>

  <form th:action="@{/attendances}"
        th:object="${attend}"
        method="post">

    <!-- LOKASI -->
    <div class="mb-3">
      <label class="form-label">Lokasi PKL</label>
      <div class="input-group">
        <span class="input-group-text">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 21h18M4 3h16M5 3v18m14-18v18"/>
          </svg>
        </span>
        <input type="text" class="form-control readonly-field"
               th:value="${attend.placement.company.companyName}" readonly>
      </div>
      <input type="hidden" th:field="*{placement}">
    </div>

    <!-- CAMERA -->
    <div class="mb-3">
      <label class="form-label">Foto Bukti Check-In</label>

      <div id="cameraBox" class="camera-box">
        <video id="video" class="camera-video" autoplay playsinline></video>
        <canvas id="canvas" class="d-none"></canvas>
        <input type="hidden" name="checkInPhotoBase64" id="photoInput">

        <div class="camera-actions">
          <button type="button"
                  class="btn btn-sm btn-outline-accent"
                  onclick="takePhoto()">
            Ambil Foto
          </button>
        </div>
      </div>

      <small class="text-muted">Selfie langsung di lokasi PKL</small>
    </div>

    <!-- JURNAL -->
    <div class="mb-3">
      <label class="form-label">Jurnal Singkat / Keterangan</label>
      <textarea th:field="*{notes}"
                class="form-control"
                rows="2"
                placeholder="Deskripsikan kegiatan hari ini secara singkat..."></textarea>
    </div>

    <!-- ACTION -->
    <div class="d-flex justify-content-end gap-2">
      <a th:href="@{/attendances}" class="btn-cancel">Batal</a>
      <button type="submit" id="submitBtn" class="btn-save" disabled>
        Simpan Absensi
      </button>
    </div>

  </form>
</main>

<!-- MODAL -->
<div class="modal fade" id="alertModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="alertTitle">Informasi</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="alertMessage"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const photoInput = document.getElementById("photoInput");
  const cameraBox = document.getElementById("cameraBox");
  const submitBtn = document.getElementById("submitBtn");

  let stream = null;

  function showModal(title, msg){
    document.getElementById("alertTitle").innerText = title;
    document.getElementById("alertMessage").innerText = msg;
    new bootstrap.Modal(document.getElementById("alertModal")).show();
  }

  async function startCamera(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:"user" }, audio:false
      });
      video.srcObject = stream;
      cameraBox.classList.add("active");
    }catch(e){
      showModal("Kamera Tidak Aktif","Izin kamera belum diberikan.");
    }
  }

  function takePhoto(){
    if(!stream){
      showModal("Perhatian","Kamera belum siap.");
      return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video,0,0);

    // freeze preview
    video.pause();
    stream.getTracks().forEach(t => t.stop());

    photoInput.value = canvas.toDataURL("image/jpeg");

    submitBtn.disabled = false;
    showModal("Berhasil","Foto berhasil diambil.");
  }

  // AUTO START CAMERA
  document.addEventListener("DOMContentLoaded", () => {
    startCamera();
  });
</script>

</body>
</html>
