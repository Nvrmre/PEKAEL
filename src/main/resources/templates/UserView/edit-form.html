<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Edit Pengguna - Sistem Monitoring</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{--navy:#0b2340;--cream:#f2ece3;--accent:#b78b4a;--muted:#6c757d}
    body{background:var(--cream);color:var(--navy);font-family:system-ui,Segoe UI,Roboto,Arial}
    .container-main{max-width:920px;margin:2rem auto;padding:1rem}
    .panel{background:#fff;border-radius:12px;padding:1.25rem;box-shadow:0 6px 18px rgba(11,35,64,.04)}
    .card-section{background:#fbfaf8;border-radius:8px;padding:1rem;border:1px solid rgba(11,35,64,.04);margin-bottom:1rem}
    .btn-primary-accent{background:var(--accent);border:0;color:#fff;padding:.5rem .9rem;border-radius:6px}
    .btn-secondary-ghost{border:1px solid rgba(11,35,64,.08);background:transparent;color:var(--navy);padding:.45rem .9rem;border-radius:6px}
  </style>
</head>
<body>
  <!-- safe fragment inclusion -->
  <div th:replace="~{layouts/fragments/navbar :: topbar}"></div>
  <div th:replace="~{layouts/fragments/sidebar :: sidebar}"></div>
  <div id="pageOverlay" class="overlay" aria-hidden="true"></div>

  <main class="container-main">
    <div class="panel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 11a3 3 0 10-6 0 3 3 0 006 0zM3 21v-2a4 4 0 014-4h6"/></svg>
          <h4 class="mb-0">Edit Pengguna</h4>
        </div>
        <a th:href="@{/users}" class="btn btn-secondary-ghost">Kembali</a>
      </div>

      <!-- form: method override to PUT -->
      <form th:action="@{/users/{id}(id=${user.userId})}" th:object="${user}" method="post" novalidate>
        <input type="hidden" name="_method" value="put"/>

        <div class="card-section">
          <label class="form-label">Nama Pengguna</label>
          <input type="text" class="form-control mb-3" th:field="*{username}" required/>

          <label class="form-label">Kata Sandi (kosongkan jika tidak diubah)</label>
          <input type="password" class="form-control mb-3" th:field="*{password}" placeholder="Kosongkan jika tidak berubah"/>

          <label class="form-label">Email</label>
          <input type="email" class="form-control mb-3" th:field="*{email}" required/>

          <label class="form-label">Role</label>
          <select id="roleSelect" class="form-select mb-3" th:field="*{role}" required>
            <option value="" disabled>-- Pilih Role --</option>
            <option th:each="r : ${roles}" th:value="${r}"
                    th:text="${r.name() == 'Student' ? 'Mahasiswa / Siswa' :
                        (r.name() == 'Company_Supervisor' ? 'Pembimbing Perusahaan' :
                        (r.name() == 'School_Supervisor' ? 'Pembimbing Sekolah' :
                        (r.name() == 'Administrator' ? 'Administrator' : r.name())))}"></option>
          </select>
        </div>

        <!-- student / company / school blocks (plain inputs named, not th:field nested) -->
        <div id="studentFields" class="card-section" style="display:none;">
          <h6>Data Siswa</h6>
          <input type="text" name="studentNumber" class="form-control mb-2"
                 th:value="${user.student != null ? user.student.studentNumber : ''}"
                 placeholder="NIS/NIM"/>
          <input type="text" name="studentPhone" class="form-control mb-2"
                 th:value="${user.student != null ? user.student.phoneNumber : ''}"
                 placeholder="Nomor HP"/>
        </div>

        <div id="companySupervisorFields" class="card-section" style="display:none;">
          <h6>Data Pembimbing Perusahaan</h6>

          <!-- Perusahaan: select dari companies -->
          <div class="mb-2">
            <label class="form-label small mb-1">Perusahaan</label>
            <select id="companySelect" name="companyId" class="form-select">
              <option value="">-- Pilih Perusahaan --</option>
              <option th:each="c : ${companies}"
                      th:value="${c.companyId}"
                      th:text="${c.companyName}"
                      th:attr="data-address=${c.companyAddress}, data-industry=${c.companyIndustry}"
                      th:selected="${user.companySupervisor != null and user.companySupervisor.company != null and user.companySupervisor.company.companyId == c.companyId}">
              </option>
            </select>
          </div>

          <!-- Pembimbing: akan difilter berdasarkan perusahaan terpilih -->
          <!-- <div class="mb-2">
            <label class="form-label small mb-1">Pembimbing Perusahaan</label>
            <select id="companySupervisorSelect" name="companySupervisorId" class="form-select">
              <option value="">-- Pilih Pembimbing --</option>
              <option th:each="s : ${allSupervisors}"
                      th:value="${s.supervisorId}"
                      th:text="${s.fullName}"
                      th:attr="data-company-id=${s.company.companyId}, data-job=${s.jobTitle}"
                      th:selected="${user.companySupervisor != null and user.companySupervisor.supervisorId == s.supervisorId}">
              </option>
            </select>
          </div> -->

          <!-- Jabatan (boleh diedit manual atau diisi otomatis ketika supervisor dipilih) -->
          <div class="mb-2">
            <label class="form-label small mb-1">Jabatan</label>
            <input type="text" id="jobTitle" name="jobTitle" class="form-control"
                   th:value="${user.companySupervisor != null ? user.companySupervisor.jobTitle : ''}"
                   placeholder="Jabatan pembimbing"/>
          </div>

          <!-- (opsional) tampilkan alamat / industry yang diambil dari company option -->
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Alamat Perusahaan</label>
              <input type="text" id="companyAddress" name="companyAddress" class="form-control"
                     th:value="${user.companySupervisor != null && user.companySupervisor.company != null ? user.companySupervisor.company.companyAddress : ''}"
                     placeholder="Alamat perusahaan (otomatis)"/>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Bidang Industri</label>
              <input type="text" id="companyIndustry" name="companyIndustry" class="form-control"
                     th:value="${user.companySupervisor != null && user.companySupervisor.company != null ? user.companySupervisor.company.companyIndustry : ''}"
                     placeholder="Bidang industri (otomatis)"/>
            </div>
          </div>

        </div>

        <div id="schoolSupervisorFields" class="card-section" style="display:none;">
          <h6>Data Pembimbing Sekolah</h6>
          <input type="text" name="employeeIdNumber" class="form-control mb-2"
                 th:value="${user.schoolSupervisor != null ? user.schoolSupervisor.employeeIdNumber : ''}"
                 placeholder="NIP"/>
          <input type="text" name="schoolPhone" class="form-control mb-2"
                 th:value="${user.schoolSupervisor != null ? user.schoolSupervisor.phone : ''}"
                 placeholder="Nomor HP"/>
        </div>

        <div class="d-flex justify-content-end gap-2">
          <button type="submit" class="btn btn-primary-accent">Simpan Perubahan</button>
        </div>
      </form>
    </div>
  </main>

  <footer style="text-align:center;color:var(--muted);padding:1rem;margin-top:1rem;">
    &copy; <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2025</span> Sistem Monitoring
  </footer>

  <script>
    // toggle role blocks
    function toggleFields() {
      const role = document.getElementById('roleSelect') ? document.getElementById('roleSelect').value : '';
      const s = document.getElementById('studentFields'), c = document.getElementById('companySupervisorFields'), sc = document.getElementById('schoolSupervisorFields');
      if (s) s.style.display = 'none';
      if (c) c.style.display = 'none';
      if (sc) sc.style.display = 'none';
      if (role === 'Student' && s) s.style.display = 'block';
      if ((role+'').includes('Company') && c) c.style.display = 'block';
      if ((role+'').includes('School') && sc) sc.style.display = 'block';
    }

    // company -> fill address/industry & filter supervisors
    document.addEventListener('DOMContentLoaded', function(){
      toggleFields();
      const roleSel = document.getElementById('roleSelect');
      if (roleSel) roleSel.addEventListener('change', toggleFields);

      const companySelect = document.getElementById('companySelect');
      const companyAddress = document.getElementById('companyAddress');
      const companyIndustry = document.getElementById('companyIndustry');
      const supervisorSelect = document.getElementById('companySupervisorSelect');
      const jobTitleInput = document.getElementById('jobTitle');

      function clearCompanyDerived() {
        if (companyAddress) companyAddress.value = '';
        if (companyIndustry) companyIndustry.value = '';
      }

      function filterSupervisorsForCompany(companyId) {
        if (!supervisorSelect) return;
        for (let i=0;i<supervisorSelect.options.length;i++) {
          const opt = supervisorSelect.options[i];
          const optCompany = opt.getAttribute('data-company-id') || '';
          if (!opt.value) { opt.style.display = ''; continue; }
          if (!companyId) {
            // sembunyikan semua pembimbing bila tidak ada perusahaan terpilih
            opt.style.display = 'none';
          } else {
            opt.style.display = (optCompany === companyId.toString()) ? '' : 'none';
          }
        }
        // jika current selected tidak terlihat, reset selection
        if (supervisorSelect.value) {
          const curOpt = supervisorSelect.options[supervisorSelect.selectedIndex];
          if (curOpt && curOpt.style.display === 'none') {
            supervisorSelect.value = '';
            if (jobTitleInput) jobTitleInput.value = '';
          }
        }
      }

      if (companySelect) {
        companySelect.addEventListener('change', function(){
          const sel = companySelect.options[companySelect.selectedIndex];
          if (!sel || !sel.value) {
            clearCompanyDerived();
            filterSupervisorsForCompany(null);
            return;
          }
          const addr = sel.getAttribute('data-address') || '';
          const ind = sel.getAttribute('data-industry') || '';
          if (companyAddress) companyAddress.value = addr;
          if (companyIndustry) companyIndustry.value = ind;
          filterSupervisorsForCompany(sel.value);
        });
      }

      if (supervisorSelect) {
        supervisorSelect.addEventListener('change', function(){
          const sel = supervisorSelect.options[supervisorSelect.selectedIndex];
          if (!sel || !sel.value) {
            if (jobTitleInput) jobTitleInput.value = '';
            return;
          }
          const j = sel.getAttribute('data-job') || '';
          if (jobTitleInput) jobTitleInput.value = j;
        });
      }

      // initialize filter & fields on load (important untuk edit form)
      if (companySelect) {
        companySelect.dispatchEvent(new Event('change'));
      } else {
        // jika tidak ada companySelect, pastikan supervisors terlihat
        if (supervisorSelect) {
          for (let i=0;i<supervisorSelect.options.length;i++) supervisorSelect.options[i].style.display = '';
        }
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
