<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daftar Tempat PKL - Sistem Monitoring</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      /* Palette Warna Modern */
      --navy: #0f172a;
      --navy-light: #1e293b;
      --accent: #b78b4a;
      --bg-body: #f1f5f9;
      --text-main: #334155;
      --text-muted: #64748b;
      --border-color: #e2e8f0;
      
      /* Status Colors */
      --success-bg: #dcfce7; --success-text: #166534;
      --warning-bg: #fef9c3; --warning-text: #854d0e;
      --info-bg: #e0f2fe;    --info-text: #075985;
      --danger-bg: #fee2e2;  --danger-text: #991b1b;
    }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
    }

    .container-main {
      max-width: 1150px;
      margin: 2.5rem auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      padding: 0;
      overflow: hidden;
    }

    /* --- Header --- */
    .page-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border-color);
      background: #fff;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-weight: 700;
      font-size: 1.35rem;
      margin: 0;
      color: var(--navy);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    h1 svg {
      color: var(--accent);
      width: 26px; height: 26px;
    }

    /* Button Add */
    .btn-add {
      background-color: var(--navy);
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.2rem;
      display: inline-flex; align-items: center; gap: 0.5rem;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    .btn-add:hover { background-color: var(--navy-light); transform: translateY(-1px); color: #fff; }

    /* Filter Section */
    .filter-section {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      min-width: 200px;
    }

    .filter-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .filter-select {
      flex: 1;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      color: var(--text-main);
      background-color: #fff;
      transition: all 0.2s;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(183, 139, 74, 0.1);
    }

    .filter-stats {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #f8fafc;
      border-radius: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .filter-stats strong {
      color: var(--navy);
      font-weight: 700;
    }

    .btn-reset {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      background: #fff;
      border-radius: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-reset:hover {
      background: #f8fafc;
      border-color: var(--accent);
      color: var(--accent);
    }

    /* --- Table Styling --- */
    .table-responsive { padding: 0; }
    .table-custom { width: 100%; margin-bottom: 0; border-collapse: collapse; }
    .table-custom thead { background-color: #f8fafc; }
    
    .table-custom th {
      text-transform: uppercase;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }

    .table-custom td {
      padding: 1rem 1.5rem;
      vertical-align: middle;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-main);
    }
    .table-custom tr:last-child td { border-bottom: none; }
    .table-custom tbody tr:hover { background-color: #f8fafc; }

    /* --- Specific Column Styling --- */
    /* Avatar Siswa */
    .student-wrapper { display: flex; align-items: center; gap: 12px; }
    .avatar-circle {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--navy), #334155);
      color: white;
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 0.9rem;
      flex-shrink: 0;
    }
    .student-info { display: flex; flex-direction: column; }
    .student-name { font-weight: 600; color: var(--navy); }
    .student-nis { font-size: 0.8rem; color: var(--text-muted); }

    /* Info Perusahaan & Pembimbing */
    .info-primary { font-weight: 600; color: var(--navy); display: block; }
    .info-secondary { font-size: 0.85rem; color: var(--text-muted); display: block; }

    /* Periode */
    .period-box {
      font-size: 0.85rem;
      background: #f1f5f9;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
      white-space: nowrap;
    }

    /* Status Badges */
    .status-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 0.35rem 0.75rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .status-ACTIVE { background: var(--success-bg); color: var(--success-text); }
    .status-COMPLETED { background: var(--info-bg); color: var(--info-text); }
    .status-PENDING { background: var(--warning-bg); color: var(--warning-text); }
    .status-CANCELLED { background: var(--danger-bg); color: var(--danger-text); }

    /* Actions */
    .action-links { display: flex; gap: 0.5rem; justify-content: flex-end; }
    .btn-icon {
      width: 32px; height: 32px;
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      border: 1px solid transparent; background: transparent;
      color: var(--text-muted); transition: all 0.2s;
    }
    .btn-icon:hover { background: #f1f5f9; color: var(--navy); transform: scale(1.1); }
    .btn-delete:hover { background: #fee2e2; color: #dc2626; }

    /* --- RESPONSIVE MOBILE (Card View) --- */
    @media (max-width: 992px) {
      .container-main { 
        margin: 1rem; 
        background: transparent; 
        box-shadow: none; 
        overflow: visible;
        border-radius: 0;
      }
      
      .page-header { 
        background: #fff; 
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .header-top {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      h1 {
        font-size: 1.2rem;
      }

      .btn-add {
        width: 100%;
        justify-content: center;
        padding: 0.7rem;
      }

      .filter-section {
        flex-direction: column;
        gap: 0.75rem;
      }

      .filter-group {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
        min-width: unset;
      }

      .filter-label {
        font-size: 0.8rem;
      }

      .filter-stats {
        width: 100%;
        justify-content: center;
      }

      .btn-reset {
        width: 100%;
        justify-content: center;
      }
      
      .table-custom thead { display: none; }
      .table-custom, .table-custom tbody, .table-custom tr, .table-custom td { 
        display: block; 
        width: 100%; 
      }
      
      .table-custom tr {
        background: #fff;
        margin-bottom: 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        padding: 1rem;
        border: 1px solid var(--border-color);
      }

      .table-custom td {
        padding: 0.65rem 0;
        border: none;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        text-align: left;
      }

      /* Label for mobile */
      .table-custom td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--text-muted);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.4rem;
      }

      /* Hide NO column on mobile */
      .td-no { display: none !important; }

      /* Custom Layout per row in mobile */
      .td-student { 
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1rem !important;
        margin-bottom: 0.5rem;
      }
      .td-student::before { display: none; }

      /* Company section */
      .td-company {
        padding: 0.65rem 0;
      }

      /* Pembimbing section */
      .td-supervisor {
        padding: 0.65rem 0;
      }

      /* Period section */
      .td-period {
        padding: 0.65rem 0;
      }

      .period-box {
        width: 100%;
        text-align: center;
        display: block;
        padding: 0.5rem;
      }

      /* Status section */
      .td-status {
        padding: 0.65rem 0;
      }

      .status-badge {
        width: 100%;
        justify-content: center;
      }

      /* Actions section */
      .td-actions {
        margin-top: 0.5rem;
        padding-top: 1rem !important;
        border-top: 1px solid var(--border-color);
      }

      .td-actions::before {
        display: none;
      }

      .action-links {
        justify-content: center;
        gap: 0.75rem;
      }

      .btn-icon {
        width: 40px;
        height: 40px;
      }

      /* Empty state adjustments */
      .table-custom tbody tr td[colspan] {
        padding: 2rem 1rem;
      }
    }
    
    footer.footer { 
      text-align: center; 
      color: var(--text-muted); 
      padding: 2rem 0; 
      font-size: 0.85rem; 
    }
  </style>
</head>

<body>
  <div th:replace="~{layouts/fragments/navbar :: topbar}"></div>
  <div th:replace="~{layouts/fragments/sidebar :: sidebar}"></div>

  <main class="container-main">
    
    <div class="page-header">
      <div class="header-top">
        <h1>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
             <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6H15m-1.5 3H15m-1.5 3H15M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" />
          </svg>
          Daftar Tempat PKL
        </h1>
        
        <a th:href="@{/placements/create}" class="btn-add" th:if="${#authorization.expression('hasAnyAuthority(''ADMINISTRATOR'', ''Administrator'')')}">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
          Tambah Placement
        </a>
      </div>

      <!-- Filter Section -->
      <div class="filter-section">
        <div class="filter-group">
          <label class="filter-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            Filter Tempat PKL:
          </label>
          <select id="companyFilter" class="filter-select">
            <option value="">Semua Tempat PKL</option>
            <option th:each="company : ${companies}" 
                    th:value="${company.companyId}"
                    th:text="${company.companyName}"
                    th:selected="${selectedCompanyId != null && selectedCompanyId == company.companyId}">
              Nama Perusahaan
            </option>
          </select>
        </div>

        <button type="button" class="btn-reset" onclick="resetFilter()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Reset
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table-custom">
        <thead>
          <tr>
            <th class="text-center td-no" style="width: 50px;">No</th>
            <th>Siswa</th>
            <th>Tempat PKL</th>
            <th>Pembimbing</th>
            <th>Periode</th>
            <th>Status</th>
            <th class="text-end" th:if="${#authorization.expression('hasAnyAuthority(''ADMINISTRATOR'', ''Administrator'')')}">Aksi</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="p, stat : ${placements}">
            
            <td class="text-center td-no" th:text="${stat.count}">1</td>

            <td class="td-student" data-label="Siswa">
              <div class="student-wrapper">
                <div class="avatar-circle">
                   <span th:text="${p.student?.user?.username != null ? #strings.substring(p.student.user.username, 0, 1).toUpperCase() : 'S'}">S</span>
                </div>
                <div class="student-info">
                  <span class="student-name" th:text="${p.student?.user?.username ?: 'Unknown'}">Nama Siswa</span>
                  <span class="student-nis" th:text="${p.student?.studentNumber != null ? 'NIS: ' + p.student.studentNumber : '-'}">NIS: 12345</span>
                </div>
              </div>
            </td>

            <td class="td-company" data-label="Tempat PKL">
               <span class="info-primary" th:text="${p.company?.companyName ?: '-'}">Nama Perusahaan</span>
               <span class="info-secondary" th:text="${p.company?.companyAddress ?: '-'}">Alamat Perusahaan</span>
            </td>

            <td class="td-supervisor" data-label="Pembimbing">
               <span class="info-primary" 
                     th:text="${p.companySupervisor?.user?.username ?: (p.schoolSupervisor?.user?.username ?: '-')}">
                     Nama Pembimbing
               </span>
               <span class="info-secondary" th:if="${p.companySupervisor != null}">Pembimbing Industri</span>
               <span class="info-secondary" th:if="${p.companySupervisor == null and p.schoolSupervisor != null}">Pembimbing Sekolah</span>
            </td>

            <td class="td-period" data-label="Periode">
               <div class="period-box">
                 <span th:text="${p.startDate != null ? #temporals.format(p.startDate, 'dd MMM yy') : '-'}">01 Jan 25</span>
                 <span class="text-muted mx-1">&rarr;</span>
                 <span th:text="${p.endDate != null ? #temporals.format(p.endDate, 'dd MMM yy') : '-'}">31 Mar 25</span>
               </div>
            </td>

            <td class="td-status" data-label="Status">
               <span th:classappend="'status-' + ${p.status}" class="status-badge">
                 <svg th:if="${#strings.toString(p.status) == 'ACTIVE'}" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                 <svg th:if="${#strings.toString(p.status) == 'PENDING'}" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                 <span th:text="${p.status}">ACTIVE</span>
               </span>
            </td>

            <td class="td-actions" th:if="${#authorization.expression('hasAnyAuthority(''ADMINISTRATOR'', ''Administrator'')')}">
              <div class="action-links">
                <a th:href="@{/placements/edit/{id}(id=${p.placementId})}" class="btn-icon" title="Edit">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </a>
                
                <a th:href="@{/placements/detail/{id}(id=${p.placementId})}" class="btn-icon" title="Detail">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.52 5 12 5c4.48 0 8.268 2.943 9.542 7-1.274 4.057-5.062 7-9.542 7-4.48 0-8.268-2.943-9.542-7z" />
                  </svg>
                </a>

                <form th:action="@{/placements/{id}(id=${p.placementId})}" method="post" class="m-0" th:id="'del-' + ${p.placementId}">
                  <input type="hidden" name="_method" value="delete" />
                  <button type="button" class="btn-icon btn-delete btn-open-delete"
                          th:attr="data-form-id='del-' + ${p.placementId}, data-name=${p.student?.user?.username}"
                          title="Hapus">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </form>
              </div>
            </td>
          </tr>

          <tr th:if="${#lists.isEmpty(placements)}">
            <td colspan="7" class="text-center py-5 text-muted">
                <div class="d-flex flex-column align-items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" stroke="#e2e8f0" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0M12 12.75h.008v.008H12v-.008z" /></svg>
                    <span class="mt-2">Belum ada data placement.</span>
                </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow">
        <div class="modal-body p-4 text-center">
          <div class="mb-3">
             <div class="mx-auto d-flex align-items-center justify-content-center rounded-circle" style="width: 50px; height: 50px; background: #fee2e2;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="#dc2626" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
             </div>
          </div>
          <h6 class="fw-bold">Hapus Placement?</h6>
          <p class="text-muted small mb-4">Tindakan ini tidak dapat dibatalkan.</p>
          <div class="d-flex gap-2 justify-content-center">
            <button type="button" class="btn btn-light w-50" data-bs-dismiss="modal">Batal</button>
            <button type="button" id="confirmDeleteBtn" class="btn btn-danger w-50">Hapus</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    &copy; <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2025</span> Sistem Monitoring
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Delete Modal Handler
      let formToSubmit = null;
      const modalEl = document.getElementById('confirmDeleteModal');
      const bsModal = new bootstrap.Modal(modalEl);
      const confirmBtn = document.getElementById('confirmDeleteBtn');

      document.querySelectorAll('.btn-open-delete').forEach(btn => {
        btn.addEventListener('click', function () {
          formToSubmit = btn.closest('form');
          bsModal.show();
        });
      });

      confirmBtn.addEventListener('click', function () {
        if (formToSubmit) {
          confirmBtn.disabled = true;
          confirmBtn.textContent = 'Menghapus...';
          formToSubmit.submit();
        }
      });

      // Filter Handler
      const companyFilter = document.getElementById('companyFilter');
      
      companyFilter.addEventListener('change', function() {
        const companyId = this.value;
        const currentUrl = new URL(window.location.href);
        
        if (companyId) {
          currentUrl.searchParams.set('companyId', companyId);
        } else {
          currentUrl.searchParams.delete('companyId');
        }
        
        window.location.href = currentUrl.toString();
      });
    });

    function resetFilter() {
      const currentUrl = new URL(window.location.href);
      currentUrl.searchParams.delete('companyId');
      window.location.href = currentUrl.toString();
    }
  </script>

</body>
</html>