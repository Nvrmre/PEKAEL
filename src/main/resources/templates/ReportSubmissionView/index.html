<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daftar Pengumpulan Laporan - Sistem Monitoring</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{ --navy:#0b2340; --cream:#f7f3ee; --accent:#b78b4a; --muted:#6c757d; }
    body{ background:var(--cream); color:var(--navy); font-family:Inter,system-ui,Arial; }
    .container-main{ max-width:1100px; margin:2rem auto; background:#fff; padding:1.25rem; border-radius:12px; box-shadow:0 8px 20px rgba(11,35,64,0.06); }
    .title { display:flex; align-items:center; gap:.75rem; margin-bottom:1rem; }
    .title h2{ margin:0; font-size:1.2rem; font-weight:700; }
    .btn-add{ background:var(--accent); color:#fff; padding:.4rem .7rem; border-radius:8px; text-decoration:none; font-weight:600; }
    .img-thumb{ width:64px; height:46px; object-fit:cover; border-radius:6px; border:1px solid #e9ecef; }
    .icon-btn{ width:36px; height:36px; border-radius:8px; display:inline-grid; place-items:center; border:0; cursor:pointer; }
    .icon-edit{ background:linear-gradient(180deg,#0b74a4,#095b7f); color:#fff; }
    .icon-delete{ background:linear-gradient(180deg,#c44d3a,#a63e2d); color:#fff; }
    .badge-status{ padding:.28rem .55rem; border-radius:999px; font-weight:700; font-size:.82rem; }
    .badge-pending{ background:#fff3cd; color:#664d03; }
    .badge-review{ background:#e6f8fb; color:var(--navy); }
    .badge-revision{ background:#fdecea; color:#8a1f2e; }

    @media(max-width:720px){
      .img-thumb{ width:48px; height:36px; }
      td, th{ font-size:.92rem; }
    }
  </style>
</head>
<body>
  <div th:replace="~{layouts/fragments/navbar :: topbar}"></div>
  <div th:replace="~{layouts/fragments/sidebar :: sidebar}"></div>

  <main class="container-main">
    <div class="d-flex justify-content-between align-items-center title">
      <h2>Daftar Pengumpulan Laporan</h2>
      <a th:href="@{/report-submissions/create}" class="btn-add"  th:if="${#authorization.expression('hasAnyAuthority(''STUDENT'', ''Student'')')}">+ Tambah Laporan</a>
    </div>

    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th style="width:56px;">No</th>
            <th style="width:80px;">File</th>
            <th>Nama Siswa</th>
            <th>Judul Laporan</th>
            <th style="width:140px;">Status</th>
            <th style="width: 140px;">Catatan</th>
            <th style="width:120px;"  th:if="${#authorization.expression('hasAnyAuthority(''ADMINISTRATOR'', ''Administrator'')')}">Aksi</th>
          </tr>
        </thead>
        <tbody>
          <!-- loop over the attribute your controller set: "submission" -->
          <tr th:each="sub, iterStat : ${submission}">
            <td th:text="${iterStat.count}">1</td>
            <td>
              <div th:if="${sub.filePath != null and sub.filePath != ''}">
                <a th:href="@{${sub.filePath}}" target="_blank" rel="noopener">
                  <img th:src="@{${sub.filePath}}" alt="file" class="img-thumb"/>
                </a>
              </div>
              <div th:if="${sub.filePath == null or sub.filePath == ''}">
                <!-- fallback debug image (local path you provided earlier) -->
                <img src="/mnt/data/16088cea-d59f-4e0d-bcde-e7e0d066cc34.png" alt="no-file" class="img-thumb"/>
              </div>
            </td>
          <td th:text="${sub.student?.user?.username ?: 'â€”'}">Nama Siswa</td>

            <td th:text="${sub.fileTitle != null ? sub.fileTitle : '-'}">Judul laporan</td>
            <td>
              <span th:switch="${sub.status}">
                <span th:case="${T(com.sistem.monitoring.models.ReportSubmissionModel.Status).PENDING}" class="badge-status badge-pending">Pending</span>
                <span th:case="${T(com.sistem.monitoring.models.ReportSubmissionModel.Status).REVIEW}" class="badge-status badge-review">Review</span>
                <span th:case="${T(com.sistem.monitoring.models.ReportSubmissionModel.Status).REVISION}" class="badge-status badge-revision">Revisi</span>
                <span th:case="*" class="badge-status badge-pending" th:text="${sub.status != null ? sub.status.name() : '-'}">-</span>
              </span>
            </td>
            <td th:text="${sub.studentNotes != null ? sub.studentNotes : '-'}">Catatan</td>
            <!-- actions: edit/delete -->
            <td>
              <div class="d-flex gap-2">
                <a th:href="@{'/report-submissions/edit/' + ${sub.submissionId}}" class="icon-btn icon-edit" title="Edit"  th:if="${#authorization.expression('hasAnyAuthority(''ADMINISTRATOR'', ''Administrator'')')}"></a>
                <form  th:if="${#authorization.expression('hasAnyAuthority(''ADMINISTRATOR'', ''Administrator'')')}" th:action="@{/report-submissions/{id}(id=${sub.submissionId})}" method="post" style="display:inline;">
                  <input type="hidden" name="_method" value="delete"/>
                  <button type="submit" class="icon-btn icon-delete" title="Hapus" onclick="return confirm('Yakin ingin menghapus?')"></button>
                </form>
              </div>
            </td>
          </tr>

          <tr th:if="${#lists.isEmpty(submission)}">
            <td colspan="6" class="text-center text-muted py-4">Belum ada laporan yang diupload.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <footer style="text-align:center; color:var(--muted); padding:1rem;">
    &copy; <span th:text="${#temporals.format(#temporals.createNow(),'yyyy')}">2025</span> Sistem Monitoring
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
